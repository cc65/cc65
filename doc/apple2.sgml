<!doctype linuxdoc system>

<article>

<title>Apple&nbsp;&rsqb;&lsqb; specific information for cc65
<author>Ullrich von Bassewitz, <htmlurl url="mailto:uz@cc65.org" name="uz@cc65.org">
<date>2003-12-16

<abstract>
An overview over the Apple&nbsp;&rsqb;&lsqb; runtime system as it is
implemented for the cc65 C compiler.
</abstract>

<!-- Table of contents -->
<toc>

<!-- Begin the document -->

<sect>Overview<p>

This file contains an overview of the Apple&nbsp;&rsqb;&lsqb; runtime system
as it comes with the cc65 C compiler. It describes the memory layout,
Apple&nbsp;&rsqb;&lsqb; specific header files, available drivers, and any
pitfalls specific to that platform.

Please note that Apple&nbsp;&rsqb;&lsqb; specific functions are just mentioned
here, they are described in detail in the separate <htmlurl url="funcref.html"
name="function reference">. Even functions marked as "platform dependent" may
be available on more than one platform. Please see the function reference for
more information.


<sect>Binary format<p>

The standard binary output format generated by the linker for the
Apple&nbsp;&rsqb;&lsqb; target is a machine language program with a 4 byte DOS
3.3 header. The standard load address is &dollar;800.

The DOS header is in its own segment named <tt/EXEHDR/. If you don't want the
header for some reason, you can change

<verb>
    HEADER: start = $0000, size = $4, file = %O;
</verb>

to

<verb>
    HEADER: start = $0000, size = $4, file = "";
</verb>

in the linker configuration to have the linker remove it.



<sect>Memory layout<p>

In the standard setup, cc65 generated programs use the memory from
&dollar;800 to &dollar;9600, so 35.5K of memory (including the stack) is
available. ROM calls are possible without further precautions.

Special locations:

<descrip>
  <tag/Stack/
  The C runtime stack is located at HIMEM and grows downwards, regardless of
  how your linker config file is setup.

  <tag/Heap/
  The C heap is located at the end of the program and grows towards the C
  runtime stack.
</descrip><p>



<sect>Platform specific header files<p>

Programs containing Apple&nbsp;&rsqb;&lsqb; specific code may use the
<tt/apple2.h/ header file.


<sect1>Apple&nbsp;&rsqb;&lsqb; specific functions<p>

The functions listed below are special for the Apple&nbsp;&rsqb;&lsqb;. See
the <htmlurl url="funcref.html" name="function reference"> for declaration and
usage.

<itemize>
<item>get_ostype
</itemize>



<sect1>Hardware access<p>

There's currently no support for direct hardware access. This does not mean
you cannot do it, it just means that there's no help.



<sect>Loadable drivers<p>

<em>Note:</em> Since the Apple&nbsp;&rsqb;&lsqb; doesn't have working disk I/O
(see <ref id="limitations" name="section &quot;Limitations&quot;">), the
available drivers cannot be loaded at runtime (so the term "loadable drivers"
is somewhat misleading). Instead, the drivers have to be converted using the
<htmlurl url="co65.html" name="co65 utility"> and statically linked. While
this may seem overhead, it has two advantages:

<enum>
<item>The interface is identical to the one used for other platforms
      and to the one for the Apple&nbsp;&rsqb;&lsqb; once it has disk I/O.
<item>Once disk I/O is available, existing code can be changed to load drivers
      at runtime with almost no effort.
</enum>



<sect1>Graphics drivers<p>

<em>Note:</em> Since memory for the high resolution graphics has to be allocated,
programs using graphics drivers will have to be linked using a special linker
configuration. See the <tt/apple2-tgi.cfg/ file in the documentation
directory, and the <htmlurl url="ld65.html" name="linker documentation"> on
how to use it.

<descrip>

  <tag><tt/a2.lo.tgi/</tag>
  This driver was written by Stefan Haubenthal. It features a resolution of
  40&times;40 with 16 colors. At the bottom of the screen, 4 additional text lines
  are available.

  <tag><tt/a2.hi.tgi/</tag>
  This driver was written by Stefan Haubenthal. It features a resolution of
  280&times;192 with 6 colors.

</descrip><p>


<sect1>Extended memory drivers<p>

<descrip>

  <tag><tt/a2.lc.emd/</tag>
  Gives access to 12KB RAM (48 pages of 256 bytes each) on the
  Apple&nbsp;&rsqb;&lsqb; language card. The driver was contributed by
  Stefan Haubenthal. Note: This driver is incompatible with any DOS using
  the language card memory!

</descrip><p>



<sect1>Joystick drivers<p>

<descrip>

  <tag><tt/a2.stdjoy.joy/</tag>
  Supports up to two standard analog joysticks connected to the game port of
  the Apple&nbsp;&rsqb;&lsqb;.

</descrip><p>



<sect1>Mouse drivers<p>

Currently no drivers available (in fact, the API for loadable mouse drivers
does not exist).


<sect1>RS232 device drivers<p>

No serial drivers are currently available for the Apple&nbsp;&rsqb;&lsqb;.



<sect>Limitations<label id="limitations"><p>

<sect1>Disk I/O<p>

The existing library for the Apple&nbsp;&rsqb;&lsqb; doesn't implement C file
I/O. There are two hacks for the <tt/read()/ and <tt/write()/ routines in
place, which will make functions work that read from or write to <tt/stdout/
(like <tt/printf()/). However, these functions have some shortcomings which
won't be fixed, because they're going to be replaced anyway.

To be more concrete, this limitation means that you cannot use any of the
following functions (and a few others):

<itemize>
<item>fclose
<item>fopen
<item>fread
<item>fprintf
<item>fputc
<item>fscanf
<item>fwrite
<item>...
</itemize>


<sect>Other hints<p>

<sect1>Passing arguments to the program<p>

Command line arguments can be passed to <tt/main()/. Since this is not
supported by BASIC, the following syntax was choosen:

<tscreen><verb>
    CALL2048:REM,ARG1," ARG2", ARG 3,, ARG5, ...
</verb></tscreen>

<enum>
<item>Arguments are separated by commas.
<item>There must be a comma after the first <tt/REM/.
<item>Leading spaces are ignored; trailing spaces are included unless the
      argument was quoted.
<item>The first argument passed to <tt/main/ is the program name.
</enum>


<sect1>Function keys<p>

These are defined to be OpenApple + number key.



<sect>Bugs/Feedback<p>

If you have problems using the library, if you find any bugs, or if you're
doing something interesting with it, I would be glad to hear from you. Feel
free to contact me by email (<htmlurl url="mailto:uz@cc65.org"
name="uz@cc65.org">).



<sect>License<p>

This software is provided 'as-is', without any expressed or implied
warranty.  In no event will the authors be held liable for any damages
arising from the use of this software.

Permission is granted to anyone to use this software for any purpose,
including commercial applications, and to alter it and redistribute it
freely, subject to the following restrictions:

<enum>
<item>	The origin of this software must not be misrepresented; you must not
	claim that you wrote the original software. If you use this software
	in a product, an acknowledgment in the product documentation would be
	appreciated but is not required.
<item>	Altered source versions must be plainly marked as such, and must not
	be misrepresented as being the original software.
<item>	This notice may not be removed or altered from any source
	distribution.
</enum>

</article>




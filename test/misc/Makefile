# Makefile for the remaining tests that need special care in one way or another

ifneq ($(shell echo),)
  CMD_EXE = 1
endif

ifdef CMD_EXE
  S = $(subst /,\,/)
  NOT = - # Hack
  EXE = .exe
  NULLDEV = nul:
  MKDIR = mkdir $(subst /,\,$1)
  RMDIR = -rmdir /s /q $(subst /,\,$1)
  DEL = del /f $(subst /,\,$1)
else
  S = /
  NOT = !
  EXE =
  NULLDEV = /dev/null
  MKDIR = mkdir -p $1
  RMDIR = $(RM) -r $1
  DEL = $(RM) $1
endif

ifdef QUIET
  .SILENT:
  NULLOUT = >$(NULLDEV)
  NULLERR = 2>$(NULLDEV)
endif

SIM65FLAGS = -x 200000000

CL65 := $(if $(wildcard ../../bin/cl65*),..$S..$Sbin$Scl65,cl65)
SIM65 := $(if $(wildcard ../../bin/sim65*),..$S..$Sbin$Ssim65,sim65)

WORKDIR = ..$S..$Stestwrk$Smisc

OPTIONS = g O Os Osi Osir Osr Oi Oir Or

DIFF = $(WORKDIR)$Sisequal$(EXE)

CC = gcc
CFLAGS = -O2

.PHONY: all clean

SOURCES := $(wildcard *.c)
TESTS  = $(foreach option,$(OPTIONS),$(SOURCES:%.c=$(WORKDIR)/%.$(option).6502.prg))
TESTS += $(foreach option,$(OPTIONS),$(SOURCES:%.c=$(WORKDIR)/%.$(option).65c02.prg))

all: $(TESTS)

# The same input file is processed with different cl65 args,
# but cl65 uses the input file name to make the temp file name,
# and they stomp each other.
.NOTPARALLEL:

$(WORKDIR):
	$(call MKDIR,$(WORKDIR))

$(DIFF): ../isequal.c | $(WORKDIR)
	$(CC) $(CFLAGS) -o $@ $<

define PRG_template

# should compile, but gives an error
$(WORKDIR)/bug250.$1.$2.prg: bug250.c | $(WORKDIR)
	@echo "FIXME: " $$@ "currently does not compile."
	$(if $(QUIET),echo misc/bug250.$1.$2.prg)
	$(NOT) $(CL65) -t sim$2 -$1 -o $$@ $$< $(NULLERR)

# should compile, but gives an error
$(WORKDIR)/bug760.$1.$2.prg: bug760.c | $(WORKDIR)
	@echo "FIXME: " $$@ "currently does not compile."
	$(if $(QUIET),echo misc/bug760.$1.$2.prg)
	$(NOT) $(CL65) -t sim$2 -$1 -o $$@ $$< $(NULLERR)

# should compile, but gives an error
$(WORKDIR)/pptest2.$1.$2.prg: pptest2.c | $(WORKDIR)
	@echo "FIXME: " $$@ "currently does not compile."
	$(if $(QUIET),echo misc/pptest2.$1.$2.prg)
	$(NOT) $(CL65) -t sim$2 -$1 -o $$@ $$< $(NULLERR)

# this should fail to compile, because cc65 does not support returning structs
$(WORKDIR)/bug264.$1.$2.prg: bug264.c | $(WORKDIR)
	@echo "FIXME: " $$@ "compiles but should give an error."
	$(if $(QUIET),echo misc/bug264.$1.$2.prg)
	$(CL65) -t sim$2 -$1 -o $$@ $$< $(NULLERR)

# this should fail to compile, because there are errors in the code
# instead, the compiler crashes
$(WORKDIR)/bug1113.$1.$2.prg: bug1113.c | $(WORKDIR)
	@echo "FIXME: " $$@ "compiler crashes but should give an error."
	$(if $(QUIET),echo misc/bug1113.$1.$2.prg)
	$(NOT) $(CL65) -t sim$2 -$1 -o $$@ $$< $(NULLERR)

# should compile, but then hangs in an endless loop
$(WORKDIR)/endless.$1.$2.prg: endless.c | $(WORKDIR)
	$(if $(QUIET),echo misc/endless.$1.$2.prg)
	$(CL65) -t sim$2 -$1 -o $$@ $$< $(NULLERR)
	$(NOT) $(SIM65) $(SIM65FLAGS) $$@ $(NULLOUT) $(NULLERR)

# these need reference data that can't be generated by a host-compiled program,
# in a useful way
$(WORKDIR)/limits.$1.$2.prg: limits.c $(DIFF) | $(WORKDIR)
	$(if $(QUIET),echo misc/limits.$1.$2.prg)
	$(CL65) -t sim$2 -$1 -o $$@ $$< $(NULLERR)
	$(SIM65) $(SIM65FLAGS) $$@ > $(WORKDIR)/limits.$1.$2.out
	$(DIFF) $(WORKDIR)/limits.$1.$2.out limits.ref

$(WORKDIR)/goto.$1.$2.prg: goto.c $(DIFF) | $(WORKDIR)
	$(if $(QUIET),echo misc/goto.$1.$2.prg)
	$(CL65) -t sim$2 -$1 -o $$@ $$< 2>$(WORKDIR)/goto.$1.$2.out
	$(DIFF) $(WORKDIR)/goto.$1.$2.out goto.ref

# the rest are tests that fail currently for one reason or another
$(WORKDIR)/sitest.$1.$2.prg: sitest.c | $(WORKDIR)
	@echo "FIXME: " $$@ "currently does not compile."
	$(NOT) $(CL65) -t sim$2 -$1 -o $$@ $$< $(NULLERR)
#	$(SIM65) $(SIM65FLAGS) $$@ $(NULLOUT)

endef # PRG_template

$(foreach option,$(OPTIONS),$(eval $(call PRG_template,$(option),6502)))
$(foreach option,$(OPTIONS),$(eval $(call PRG_template,$(option),65c02)))

clean:
	@$(call RMDIR,$(WORKDIR))
	@$(call DEL,$(SOURCES:.c=.o))
